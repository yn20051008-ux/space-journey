<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>目標管理｜言語化 × 毎日チェック × 数値グラフ</title>
<!-- Chart.js（CDN）-->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<style>
  :root{
    --bg:#0f1216; --card:#171b21; --muted:#8ea0b5; --text:#e7edf5;
    --ok:#16a34a; --ng:#ef4444; --primary:#4691eb; --chip:#233043;
    --accent:#f59e0b; --border:#223042;
  }
  *{box-sizing:border-box}
  body{
    margin:0; background:var(--bg); color:var(--text);
    font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
  }
  header{
    position:sticky; top:0; z-index:3; backdrop-filter: blur(6px);
    background:linear-gradient(180deg, rgba(15,18,22,.9), rgba(15,18,22,.75));
    border-bottom:1px solid var(--border);
  }
  .wrap{max-width:1100px; margin:auto; padding:16px}
  h1{margin:0 0 6px; font-size:20px}
  .sub{color:var(--muted); font-size:12px}
  .toolbar{
    display:flex; gap:8px; flex-wrap:wrap; margin-top:10px
  }
  button,.btn{
    background:var(--primary); color:white; border:0; border-radius:10px;
    padding:10px 14px; font-weight:600; cursor:pointer;
  }
  button.ghost{background:#233043}
  button.warn{background:#c2410c}
  button:disabled{opacity:.5; cursor:not-allowed}
  input,select,textarea{
    width:100%; background:#0b0f14; color:var(--text);
    border:1px solid var(--border); border-radius:10px; padding:10px;
  }
  textarea{min-height:72px; resize:vertical}
  .grid{display:grid; gap:16px}
  @media(min-width:900px){ .grid{grid-template-columns: 340px 1fr} }
  .card{
    background:var(--card); border:1px solid var(--border);
    border-radius:16px; padding:16px;
  }
  .goal-item{
    display:flex; align-items:center; gap:10px; padding:10px;
    border:1px solid var(--border); border-radius:12px; margin-bottom:10px;
  }
  .goal-item .meta{flex:1}
  .goal-item .title{font-weight:700}
  .chip{display:inline-block; padding:4px 8px; border-radius:999px; background:var(--chip); color:#cfe0ff; font-size:12px}
  .danger{color:#ffb4b4}
  .ok{color:#b6ffcf}
  .muted{color:var(--muted)}
  .sec-title{margin:0 0 8px; font-size:14px; color:#cfe0ff}
  .calendar{
    display:grid; grid-template-columns:repeat(7,1fr); gap:6px; margin-top:12px
  }
  .day{
    aspect-ratio:1/1; display:flex; align-items:center; justify-content:center;
    border-radius:8px; border:1px solid var(--border); font-size:12px; color:#9fb3c8;
    background:#0b0f14; cursor:pointer; user-select:none;
  }
  .day.off{opacity:.3; cursor:default}
  .day.done{background:#0f2b1d; border-color:#1f4e38; color:#d0ffe6; box-shadow:inset 0 0 0 2px #1f4e38}
  .legend{display:flex; gap:10px; margin-top:8px; font-size:12px; color:var(--muted)}
  .legend > span{display:flex; gap:6px; align-items:center}
  .box{width:14px; height:14px; border-radius:4px; border:1px solid var(--border)}
  .box.ok{background:#0f2b1d; border-color:#1f4e38}
  .flex{display:flex; gap:10px; align-items:center}
  .split{display:grid; gap:10px}
  @media(min-width:560px){.split{grid-template-columns: 1fr 1fr}}
  .right{display:flex; gap:8px; margin-left:auto}
  .kpi{display:grid; gap:6px; grid-template-columns:repeat(2,1fr)}
  .kpi .cell{background:#0b0f14; border:1px solid var(--border); padding:10px; border-radius:12px}
  .cell b{display:block; font-size:18px}
  footer{padding:40px 0; text-align:center; color:var(--muted)}
  .small{font-size:12px}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>目標管理 <span class="sub">｜言語化／毎日チェック／数値グラフ</span></h1>
    <div class="toolbar">
      <button id="addGoalBtn">＋ 目標を追加</button>
      <button class="ghost" id="exportBtn">データをエクスポート</button>
      <label class="btn ghost" for="importFile" style="display:inline-block">インポート</label>
      <input id="importFile" type="file" accept="application/json" hidden>
      <span class="sub">データは自動で端末に保存（localStorage）</span>
    </div>
  </div>
</header>

<main class="wrap grid">
  <!-- 左：目標リスト + 目標編集 -->
  <section>
    <div class="card">
      <h3 class="sec-title">目標</h3>
      <div id="goalList"></div>
    </div>

    <div class="card" id="editorCard">
      <h3 class="sec-title" id="editorTitle">新しい目標</h3>
      <div class="split">
        <div>
          <label class="small">目標名</label>
          <input id="gTitle" placeholder="例）毎朝6:00起床 / 体重管理 / YouTube登録者" />
        </div>
        <div>
          <label class="small">カテゴリー</label>
          <select id="gCategory">
            <option>習慣</option>
            <option>学習</option>
            <option>健康</option>
            <option>仕事</option>
            <option>クリエイティブ</option>
          </select>
        </div>
      </div>
      <div style="margin-top:8px">
        <label class="small">目標の言語化（ステートメント）</label>
        <textarea id="gStatement" placeholder="例）将来の自分の土台をつくるため、平日6時に起きて30分の静かな時間を確保する。"></textarea>
      </div>
      <div class="split" style="margin-top:8px">
        <div>
          <label class="small">数値の単位（任意）</label>
          <input id="gUnit" placeholder="例）kg, 人, 円, 冊, Step など">
        </div>
        <div>
          <label class="small">目標値（任意）</label>
          <input id="gTarget" type="number" step="any" placeholder="例）65">
        </div>
      </div>
      <div class="flex" style="margin-top:12px">
        <button id="saveGoalBtn">保存</button>
        <button class="ghost" id="resetEditorBtn">クリア</button>
        <div class="right">
          <button class="warn" id="deleteGoalBtn" style="display:none">削除</button>
        </div>
      </div>
    </div>
  </section>

  <!-- 右：日次チェック + グラフ -->
  <section>
    <div class="card">
      <div class="flex" style="justify-content:space-between">
        <h3 class="sec-title">毎日チェック & 数値入力</h3>
        <div class="right">
          <button class="ghost" id="prevMonthBtn">◀︎</button>
          <div id="monthLabel" class="sub" style="min-width:120px; text-align:center"></div>
          <button class="ghost" id="nextMonthBtn">▶︎</button>
          <button class="ghost" id="todayBtn">今日へ</button>
        </div>
      </div>

      <div id="activeGoalBox" class="small" style="margin:4px 0 10px"></div>

      <div class="kpi" style="margin-bottom:10px">
        <div class="cell"><span class="muted small">今月の達成率</span><b id="kpiRate">-</b></div>
        <div class="cell"><span class="muted small">連続ストリーク</span><b id="kpiStreak">-</b></div>
      </div>

      <div id="calendar" class="calendar"></div>
      <div class="legend">
        <span><span class="box ok"></span>やった</span>
        <span><span class="box" style="background:#0b0f14"></span>未実施</span>
      </div>

      <div style="margin-top:16px" class="split">
        <div>
          <label class="small">今日の数値（任意）</label>
          <div class="flex">
            <input id="todayValue" type="number" step="any" placeholder="例）体重 67.8 / 登録者 3 / 売上 12000" />
            <button id="saveValueBtn">記録</button>
          </div>
          <div class="small muted" id="valueHint"></div>
        </div>
        <div>
          <label class="small">今日のメモ（任意）</label>
          <input id="todayNote" placeholder="例）外食、睡眠不足、動画投稿 など">
        </div>
      </div>
    </div>

    <div class="card">
      <h3 class="sec-title">数値グラフ</h3>
      <canvas id="chart" height="120"></canvas>
    </div>
  </section>
</main>

<footer>
  <div class="wrap small">© 2025 目標管理サンプル。GitHub Pages にアップするだけでOK。</div>
</footer>

<script>
/* ========= データ層 ========= */
const STORAGE_KEY = 'goals.v1';
let state = load() || {
  goals: [
    seedGoal('毎朝6:00起床', '習慣',
      '天の軌道に合わせるため、平日6:00に起床し静かな時間を30分確保する。', '', ''),
    seedGoal('体重管理', '健康',
      '健康寿命を伸ばすために、体重と食事の関係を毎日観察する。', 'kg', 65),
    seedGoal('YouTube登録者', 'クリエイティブ',
      '日本×韓国の視点で楽しい動画を作り、ファンと共に育つ。', '人', 1000),
  ],
  activeGoalId: null,
  monthCursor: todayStr().slice(0,7) // YYYY-MM
};
if(!state.activeGoalId && state.goals.length) state.activeGoalId = state.goals[0].id;
save();

function seedGoal(title, cat, statement, unit, target){
  return {
    id: crypto.randomUUID(),
    title, category:cat, statement,
    unit, target: target===''? '': Number(target),
    createdAt: todayStr(),
    days: {} // 'YYYY-MM-DD': {done:true/false, value:number?, note:string?}
  }
}

function load(){
  try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)); }catch(e){ return null }
}
function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

/* ========= UI ヘルパ ========= */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
function todayStr(d=new Date()){ return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10); }
function yearMonthStr(date){ return date.toISOString().slice(0,7); }
function fmt(n){ if(n=== '' || n===null || n===undefined || isNaN(n)) return '-'; return (''+Number(n)).replace(/(\.\d{0,2}).*$/,'$1'); }

/* ========= 目標リスト ========= */
const goalList = $('#goalList');
const editor = {
  id:null, title:$('#gTitle'), cat:$('#gCategory'), st:$('#gStatement'), unit:$('#gUnit'), target:$('#gTarget')
};
function renderGoals(){
  goalList.innerHTML = '';
  if(!state.goals.length){
    goalList.innerHTML = '<p class="muted small">目標がありません。「＋ 目標を追加」から作成してください。</p>';
    return;
  }
  state.goals.forEach(g=>{
    const div = document.createElement('div');
    div.className = 'goal-item';
    div.innerHTML = `
      <input type="radio" name="activeGoal" ${g.id===state.activeGoalId?'checked':''} style="width:18px;height:18px">
      <div class="meta">
        <div class="title">${g.title} <span class="chip">${g.category}</span></div>
        <div class="muted small">${g.statement ? g.statement.replace(/\n/g,' ') : '（ステートメント未入力）'}</div>
        <div class="small" style="margin-top:6px">
          目標値: <b>${fmt(g.target)}</b> ${g.unit||''}
          <span class="muted">／ 作成: ${g.createdAt}</span>
        </div>
      </div>
      <div class="right">
        <button class="ghost editBtn">編集</button>
      </div>
    `;
    div.querySelector('input').addEventListener('change', ()=>{
      state.activeGoalId = g.id; save(); refreshRight(); });
    div.querySelector('.editBtn').addEventListener('click', ()=>editGoal(g.id));
    goalList.appendChild(div);
  });
}
function editGoal(id){
  const g = state.goals.find(x=>x.id===id) || seedGoal('','','','','');
  editor.id = g.id || null;
  $('#editorTitle').textContent = g.id ? '目標を編集' : '新しい目標';
  editor.title.value = g.title||'';
  editor.cat.value = g.category||'習慣';
  editor.st.value = g.statement||'';
  editor.unit.value = g.unit||'';
  editor.target.value = g.target===''?'':g.target;
  $('#deleteGoalBtn').style.display = g.id? 'inline-block':'none';
}
function resetEditor(){
  editor.id=null; $('#editorTitle').textContent='新しい目標';
  editor.title.value=''; editor.cat.value='習慣'; editor.st.value='';
  editor.unit.value=''; editor.target.value='';
  $('#deleteGoalBtn').style.display='none';
}
$('#addGoalBtn').onclick = ()=>{ resetEditor(); window.scrollTo({top:0, behavior:'smooth'}) };
$('#resetEditorBtn').onclick = resetEditor;
$('#saveGoalBtn').onclick = ()=>{
  const t = editor.title.value.trim();
  if(!t){ alert('目標名を入力してください'); return; }
  const payload = {
    title:t, category:editor.cat.value, statement:editor.st.value.trim(),
    unit:editor.unit.value.trim(), target: editor.target.value===''?'': Number(editor.target.value)
  };
  if(editor.id){
    const g = state.goals.find(x=>x.id===editor.id);
    Object.assign(g, payload);
  }else{
    const g = seedGoal(payload.title, payload.category, payload.statement, payload.unit, payload.target);
    state.goals.unshift(g); state.activeGoalId = g.id;
  }
  save(); renderGoals(); refreshRight(); resetEditor();
}
$('#deleteGoalBtn').onclick = ()=>{
  if(!editor.id) return;
  if(!confirm('この目標を削除しますか？')) return;
  state.goals = state.goals.filter(x=>x.id!==editor.id);
  if(!state.goals.length) state.activeGoalId=null;
  else if(!state.goals.find(x=>x.id===state.activeGoalId)) state.activeGoalId = state.goals[0].id;
  save(); renderGoals(); refreshRight(); resetEditor();
}

/* ========= カレンダー & 右側 ========= */
const cal = $('#calendar');
const monthLabel = $('#monthLabel');
$('#prevMonthBtn').onclick = ()=> shiftMonth(-1);
$('#nextMonthBtn').onclick = ()=> shiftMonth(+1);
$('#todayBtn').onclick = ()=> { state.monthCursor = todayStr().slice(0,7); save(); refreshRight(); };

function shiftMonth(delta){
  const [y,m] = state.monthCursor.split('-').map(Number);
  const d = new Date(y, m-1+delta, 1);
  state.monthCursor = yearMonthStr(d); save(); refreshRight();
}
function refreshRight(){
  const g = state.goals.find(x=>x.id===state.activeGoalId);
  if(!g){ cal.innerHTML='<p class="muted small">目標を選択してください。</p>'; $('#activeGoalBox').innerHTML=''; return; }
  $('#activeGoalBox').innerHTML = `
    <div><b>${g.title}</b> <span class="chip">${g.category}</span></div>
    <div class="muted small">${g.statement?g.statement.replace(/\n/g,' ') : '（ステートメント未入力）'}</div>
    <div class="small">目標値: <b>${fmt(g.target)}</b> ${g.unit||''}</div>
  `;

  // カレンダー生成
  const [yy,mm] = state.monthCursor.split('-').map(Number);
  const first = new Date(yy, mm-1, 1);
  const start = new Date(first); start.setDate(start.getDate() - ((first.getDay()+6)%7)); // 月曜始まり
  const days = [];
  for(let i=0;i<42;i++){
    const d = new Date(start); d.setDate(start.getDate()+i);
    const key = todayStr(d);
    const item = g.days[key] || {};
    days.push({date:d, key, ownMonth: d.getMonth()===first.getMonth(), done: !!item.done});
  }
  monthLabel.textContent = `${yy}年 ${mm}月`;
  cal.innerHTML = '';
  days.forEach(({date,key,ownMonth,done})=>{
    const el = document.createElement('div');
    el.className = 'day'+(ownMonth?'':' off')+(done?' done':'');
    el.title = key;
    el.textContent = date.getDate();
    if(ownMonth){
      el.onclick = ()=>{
        const rec = g.days[key] || {};
        rec.done = !rec.done;
        g.days[key] = rec;
        save(); refreshRight();
      };
    }
    cal.appendChild(el);
  });

  // KPI
  const monthKeys = Object.keys(g.days).filter(k=>k.startsWith(state.monthCursor));
  const total = days.filter(d=>d.ownMonth).length;
  const doneCount = days.filter(d=>d.ownMonth && d.done).length;
  $('#kpiRate').textContent = total? Math.round(doneCount/total*100)+'%':'-';
  $('#kpiStreak').textContent = calcStreak(g);

  // 値入力UI
  const todayKey = todayStr();
  const rec = g.days[todayKey] || {};
  $('#todayValue').value = rec.value ?? '';
  $('#todayNote').value = rec.note ?? '';
  const unitLabel = g.unit? `（単位：${g.unit}）` : '';
  $('#valueHint').textContent = g.target!=='' ? `目標値：${g.target} ${g.unit||''}`: unitLabel;

  // チャート
  renderChart(g);
}

$('#saveValueBtn').onclick = ()=>{
  const g = state.goals.find(x=>x.id===state.activeGoalId);
  if(!g) return;
  const key = todayStr();
  const rec = g.days[key] || {};
  const val = $('#todayValue').value;
  const note = $('#todayNote').value.trim();
  rec.value = val===''? undefined : Number(val);
  rec.note = note||undefined;
  g.days[key] = rec;
  save(); refreshRight();
};

/* ========= ストリーク計算 ========= */
function calcStreak(g){
  let streak = 0;
  for(let i=0;i<9999;i++){
    const d = new Date(); d.setDate(d.getDate()-i);
    const k = todayStr(d);
    const rec = g.days[k]; if(rec && rec.done){ streak++; } else break;
  }
  return streak ? streak+' 日' : '0 日';
}

/* ========= グラフ ========= */
let chart;
function renderChart(g){
  const entries = Object.entries(g.days)
    .filter(([k,v])=> v.value !== undefined)
    .sort((a,b)=> a[0].localeCompare(b[0]));
  const labels = entries.map(([k])=> k.slice(5)); // MM-DD 表示
  const data = entries.map(([,v])=> v.value);
  if(chart){ chart.destroy(); }
  const ctx = document.getElementById('chart');
  chart = new Chart(ctx, {
    type:'line',
    data:{ labels, datasets:[{ label: g.title+(g.unit?`（${g.unit}）`:''), data, tension:.3 }]},
    options:{
      responsive:true, maintainAspectRatio:false,
      plugins:{ legend:{labels:{color:'#cfe0ff'}}, tooltip:{mode:'index', intersect:false}},
      scales:{
        x:{ ticks:{color:'#9fb3c8'}, grid:{color:'#213046'} },
        y:{ ticks:{color:'#9fb3c8'}, grid:{color:'#213046'} }
      }
    }
  });
}

/* ========= エクスポート/インポート ========= */
$('#exportBtn').onclick = ()=>{
  const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `goals-export-${todayStr()}.json`;
  a.click(); URL.revokeObjectURL(a.href);
};
$('#importFile').addEventListener('change', (e)=>{
  const file = e.target.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = ()=>{
    try{
      const obj = JSON.parse(reader.result);
      if(!obj.goals) throw new Error('形式が違います');
      state = obj; save(); renderGoals(); refreshRight(); alert('インポート完了');
    }catch(err){ alert('読み込みエラー: '+err.message); }
  };
  reader.readAsText(file);
});

/* ========= 起動 ========= */
renderGoals();
refreshRight();
editGoal(state.activeGoalId);

/* ========= キーボード小ワザ ========= */
document.addEventListener('keydown',(e)=>{
  if(e.key==='ArrowLeft' && (e.ctrlKey||e.metaKey)) shiftMonth(-1);
  if(e.key==='ArrowRight'&& (e.ctrlKey||e.metaKey)) shiftMonth(+1);
});
</script>
</body>
</html>