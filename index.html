<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>現在地ダッシュボード｜人生逆算MVP</title>
<meta name="theme-color" content="#0f1216" />
<style>
  :root{
    --bg:#0f1216; --card:#171b21; --muted:#8ea0b5; --text:#e7edf5; --acc:#60a5fa; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444;
    --ring:#223249; --chip:#202734;
  }
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'Apple Color Emoji','Segoe UI Emoji',sans-serif;}
  .wrap{max-width:720px;margin:0 auto;padding:16px}
  header{position:sticky;top:0;background:linear-gradient(180deg,rgba(15,18,22,.95),rgba(15,18,22,.85));backdrop-filter:saturate(180%) blur(8px);z-index:10;border-bottom:1px solid #20242c}
  header .wrap{display:flex;gap:8px;align-items:center;padding:12px 16px}
  h1{font-size:18px;margin:0;letter-spacing:.02em}
  .btn{appearance:none;border:1px solid var(--ring);background:var(--chip);color:var(--text);padding:10px 12px;border-radius:10px;font-size:14px}
  .btn.primary{border-color:#2b5ab7;background:#1f2b47}
  .btn.ghost{background:transparent}
  .row{display:flex;gap:8px}
  .grid{display:grid;gap:12px}
  .card{background:var(--card);border:1px solid var(--ring);border-radius:16px;padding:14px}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
  input,select,textarea{width:100%;box-sizing:border-box;background:#0e131a;border:1px solid #273142;color:var(--text);padding:12px;border-radius:12px;font-size:16px}
  textarea{min-height:84px;resize:vertical}
  .kpi{display:flex;gap:10px;align-items:center;justify-content:space-between;background:#0e131a;border:1px solid #273142;border-radius:12px;padding:10px 12px}
  .kpi b{font-size:18px}
  .pill{font-size:12px;padding:6px 8px;border-radius:999px;background:#111827;border:1px solid #223249;color:#cbd5e1}
  .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .right{margin-left:auto}
  .danger{color:#fecaca;border-color:#7f1d1d}
  .ok{color:#bbf7d0;border-color:#14532d}
  .warn{color:#fde68a;border-color:#7c2d12}
  .muted{color:var(--muted)}
  .small{font-size:12px}
  .section-title{margin:4px 0 8px 0;font-size:14px;color:#b9c7d9}
  .list{display:grid;gap:8px}
  .item{display:grid;gap:8px;padding:12px;border:1px solid #223249;border-radius:12px;background:#0e131a}
  .split{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  @media (min-width:560px){ .split{grid-template-columns:1fr 1fr 1fr} }
  .progress{height:10px;background:#121826;border:1px solid #223249;border-radius:999px;overflow:hidden}
  .bar{height:100%;background:linear-gradient(90deg,#60a5fa,#22d3ee)}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap}
  .footer{padding:40px 0 80px;color:#71839b;text-align:center}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>現在地ダッシュボード</h1>
    <button id="exportBtn" class="btn pill right">エクスポート</button>
    <label for="importFile" class="btn pill">インポート</label>
    <input id="importFile" type="file" accept="application/json" style="display:none" />
  </div>
</header>

<main class="wrap grid" id="app">

  <!-- カテゴリ選択 / 追加 -->
  <section class="card grid">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div class="flex">
        <span class="pill">カテゴリ</span>
        <select id="categorySelect"></select>
      </div>
      <button id="addCategoryBtn" class="btn">＋ カテゴリ追加</button>
    </div>
    <div id="categoryHint" class="small muted">例：フォロワー数 / 体重 / 月収 など。自由に追加できます。</div>
  </section>

  <!-- 目標入力 -->
  <section class="card grid">
    <div class="section-title">目標設定 & 逆算</div>
    <div class="split">
      <div>
        <label>目標タイトル</label>
        <input id="goalTitle" placeholder="例：体重 65kg / フォロワー 1万人 / 月収 50万円">
      </div>
      <div>
        <label>単位（任意）</label>
        <input id="goalUnit" placeholder="例：kg, 人, 円">
      </div>
      <div>
        <label>目標値（数値）</label>
        <input id="goalTarget" type="number" inputmode="decimal" placeholder="例：65 or 10000 or 500000">
      </div>
      <div>
        <label>現在値（数値 / 初回）</label>
        <input id="goalCurrent" type="number" inputmode="decimal" placeholder="例：72">
      </div>
      <div>
        <label>期限</label>
        <input id="goalDeadline" type="date">
      </div>
      <div style="display:flex;align-items:flex-end">
        <button id="addGoalBtn" class="btn primary" style="width:100%">＋ 目標を登録</button>
      </div>
    </div>
    <div class="small muted">※ 逆算は「(目標−現在) ÷ 残り日数」で1日あたりの必要量を表示します（減量などマイナス目標にも対応）。</div>
  </section>

  <!-- 現在地（選択カテゴリのサマリ） -->
  <section class="card grid" id="summaryCard" style="display:none">
    <div class="section-title">現在地（選択カテゴリ）</div>
    <div class="kpi">
      <div>
        <div class="small muted">進捗</div>
        <b id="sumProgress">0%</b>
      </div>
      <div>
        <div class="small muted">残り日数</div>
        <b id="sumDaysLeft">—</b>
      </div>
      <div>
        <div class="small muted">1日あたり必要量</div>
        <b id="sumPerDay">—</b>
      </div>
    </div>
    <div class="progress"><div id="sumBar" class="bar" style="width:0%"></div></div>
    <div id="paceNote" class="small muted"></div>
  </section>

  <!-- 目標一覧（カテゴリ内） -->
  <section class="card grid">
    <div class="section-title">目標一覧</div>
    <div id="goalsList" class="list"></div>
  </section>

</main>

<footer class="footer small">
  v0.1 MVP / 端末保存（localStorage）。バックアップは右上のエクスポートをご利用ください。
</footer>

<script>
(function(){
  const KEY = 'life-mvp-v01';

  /** ---------- 状態 ---------- */
  let state = load() || seed();

  function seed(){
    // 初回に3カテゴリだけ用意（自由に消せます）
    return {
      categories: [
        { id: uid(), name:'フォロワー数', goals:[] },
        { id: uid(), name:'体重', goals:[] },
        { id: uid(), name:'月収', goals:[] },
      ],
      selectedCategoryId: null
    };
  }

  function uid(){ return Math.random().toString(36).slice(2,9); }
  function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }
  function load(){ try{ return JSON.parse(localStorage.getItem(KEY)); }catch(e){ return null; } }

  /** ---------- DOM ---------- */
  const selCat = document.getElementById('categorySelect');
  const addCategoryBtn = document.getElementById('addCategoryBtn');
  const addGoalBtn = document.getElementById('addGoalBtn');
  const goalsList = document.getElementById('goalsList');
  const exportBtn = document.getElementById('exportBtn');
  const importFile = document.getElementById('importFile');

  const goalTitle = document.getElementById('goalTitle');
  const goalUnit = document.getElementById('goalUnit');
  const goalTarget = document.getElementById('goalTarget');
  const goalCurrent = document.getElementById('goalCurrent');
  const goalDeadline = document.getElementById('goalDeadline');

  const sumCard = document.getElementById('summaryCard');
  const sumProgress = document.getElementById('sumProgress');
  const sumDaysLeft = document.getElementById('sumDaysLeft');
  const sumPerDay = document.getElementById('sumPerDay');
  const sumBar = document.getElementById('sumBar');
  const paceNote = document.getElementById('paceNote');

  /** ---------- 初期描画 ---------- */
  renderCategories();
  if(!state.selectedCategoryId && state.categories[0]){
    state.selectedCategoryId = state.categories[0].id; save();
  }
  renderAll();

  /** ---------- カテゴリ ---------- */
  addCategoryBtn.addEventListener('click', () => {
    const name = prompt('カテゴリ名を入力（例：英語学習、資産、読書数など）');
    if(!name) return;
    state.categories.push({ id: uid(), name, goals:[] });
    state.selectedCategoryId = state.categories[state.categories.length-1].id;
    save(); renderCategories(); renderAll();
  });

  selCat.addEventListener('change', () => {
    state.selectedCategoryId = selCat.value;
    save(); renderAll();
  });

  function renderCategories(){
    selCat.innerHTML = '';
    state.categories.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c.id; opt.textContent = c.name;
      if(c.id === state.selectedCategoryId) opt.selected = true;
      selCat.appendChild(opt);
    });
  }

  /** ---------- 目標追加 ---------- */
  addGoalBtn.addEventListener('click', () => {
    const title = (goalTitle.value || '').trim();
    const unit = (goalUnit.value || '').trim();
    const target = Number(goalTarget.value);
    const current = Number(goalCurrent.value);
    const deadline = goalDeadline.value;

    if(!state.selectedCategoryId){ alert('先にカテゴリを選択/作成してください'); return; }
    if(!title){ alert('目標タイトルを入力してください'); return; }
    if(!deadline){ alert('期限（日付）を選んでください'); return; }
    if(Number.isNaN(target) || Number.isNaN(current)){ alert('目標値と現在値は数値で入力してください'); return; }

    const cat = state.categories.find(c=>c.id===state.selectedCategoryId);
    cat.goals.push({
      id: uid(), title, unit, target, deadline,
      history: [{ date: today(), value: current }],
      note: ''
    });
    save();
    // 入力リセット
    goalTitle.value = ''; goalUnit.value=''; goalTarget.value=''; goalCurrent.value=''; goalDeadline.value='';
    renderAll();
  });

  /** ---------- 画面描画 ---------- */
  function renderAll(){
    const cat = state.categories.find(c=>c.id===state.selectedCategoryId);
    renderSummary(cat);
    renderGoals(cat);
  }

  function renderSummary(cat){
    if(!cat || cat.goals.length===0){ sumCard.style.display='none'; return; }
    sumCard.style.display='grid';

    // 代表：最も期限が近い目標でサマリ表示
    const soon = [...cat.goals].sort((a,b)=>a.deadline.localeCompare(b.deadline))[0];
    const {progress, daysLeft, perDay, direction} = calc(soon);

    sumProgress.textContent = `${progress}%`;
    sumDaysLeft.textContent = daysLeft >= 0 ? `${daysLeft}日` : `期限超過(${Math.abs(daysLeft)}日)`;
    sumPerDay.textContent = perDay === null ? '—' : `${perDay}${soon.unit||''}/日`;
    sumBar.style.width = `${progress}%`;

    let note = `代表目標：「${soon.title}」`;
    if(perDay !== null){
      note += `。今日から ${direction}${Math.abs(perDay)}${soon.unit||''}/日 のペースでOK`;
    }
    paceNote.textContent = note;
  }

  function renderGoals(cat){
    goalsList.innerHTML = '';
    if(!cat){ return; }
    cat.goals.forEach(goal => {
      const h = latest(goal);
      const {progress, daysLeft, perDay, needs} = calc(goal);

      const wrap = document.createElement('div');
      wrap.className = 'item';
      wrap.innerHTML = `
        <div class="flex" style="justify-content:space-between;">
          <div class="flex" style="gap:6px;align-items:baseline">
            <b>${escapeHtml(goal.title)}</b>
            ${goal.unit? `<span class="pill">${escapeHtml(goal.unit)}</span>`:''}
          </div>
          <div class="toolbar">
            <button class="btn small ghost" data-act="edit">編集</button>
            <button class="btn small ghost danger" data-act="del">削除</button>
          </div>
        </div>

        <div class="split">
          <div class="kpi"><div class="small muted">現在値</div><b>${fmt(h.value)}${goal.unit||''}</b></div>
          <div class="kpi"><div class="small muted">目標値</div><b>${fmt(goal.target)}${goal.unit||''}</b></div>
          <div class="kpi"><div class="small muted">期限</div><b>${goal.deadline}</b></div>
        </div>

        <div class="progress"><div class="bar" style="width:${progress}%"></div></div>
        <div class="flex">
          <span class="pill ${badgeColor(progress)}">進捗 ${progress}%</span>
          <span class="pill">${daysLeft>=0?`残り ${daysLeft}日`:`期限超過 ${Math.abs(daysLeft)}日`}</span>
          <span class="pill">${perDay===null?`目標到達`: `必要 ${needs}`}</span>
        </div>

        <div class="split">
          <div>
            <label>今日の記録（数値を入力）</label>
            <input type="number" inputmode="decimal" placeholder="例：68" data-field="daily">
          </div>
          <div style="display:flex;align-items:flex-end">
            <button class="btn" data-act="addDaily">＋ 記録</button>
          </div>
          <div>
            <label>軌道修正メモ（任意）</label>
            <textarea data-field="note" placeholder="例：出張で外食が続いたので週末で調整など。">${escapeHtml(goal.note||'')}</textarea>
          </div>
          <div style="display:flex;align-items:flex-end">
            <button class="btn" data-act="saveNote">メモ保存</button>
          </div>
        </div>

        <div class="small muted">履歴：${goal.history.slice(-5).map(r=>`${r.date}:${fmt(r.value)}`).join(' / ')}</div>
      `;

      // イベント
      wrap.querySelector('[data-act="addDaily"]').addEventListener('click', ()=>{
        const v = wrap.querySelector('[data-field="daily"]').value;
        if(v===''){ alert('数値を入力してください'); return; }
        goal.history.push({ date: today(), value: Number(v) });
        save(); renderAll();
      });

      wrap.querySelector('[data-act="saveNote"]').addEventListener('click', ()=>{
        goal.note = wrap.querySelector('[data-field="note"]').value || '';
        save();
      });

      wrap.querySelector('[data-act="del"]').addEventListener('click', ()=>{
        if(!confirm('この目標を削除します。よろしいですか？')) return;
        cat.goals = cat.goals.filter(g=>g.id!==goal.id);
        save(); renderAll();
      });

      wrap.querySelector('[data-act="edit"]').addEventListener('click', ()=>{
        const title = prompt('タイトル', goal.title) ?? goal.title;
        const unit = prompt('単位（空でも可）', goal.unit||'') ?? (goal.unit||'');
        const target = Number(prompt('目標値', goal.target));
        const deadline = prompt('期限 (YYYY-MM-DD)', goal.deadline) ?? goal.deadline;
        if(Number.isNaN(target)){ alert('目標値は数値で'); return; }
        goal.title = title.trim()||goal.title;
        goal.unit = unit.trim();
        goal.target = target;
        goal.deadline = deadline;
        save(); renderAll();
      });

      goalsList.appendChild(wrap);
    });
  }

  /** ---------- 計算系 ---------- */
  function latest(goal){ return goal.history[goal.history.length-1]; }
  function daysUntil(dateStr){
    const today = new Date(); today.setHours(0,0,0,0);
    const d = new Date(dateStr); d.setHours(0,0,0,0);
    return Math.round((d - today) / (1000*60*60*24));
  }
  function calc(goal){
    const cur = latest(goal).value;
    const target = goal.target;
    const dist = target - cur; // 正:増やす, 負:減らす
    const daysLeft = daysUntil(goal.deadline);
    let progress;
    // 進捗%: 目標方向にどれだけ近づいたか（現在値と初期値が同じと仮定）
    const start = goal.history[0]?.value ?? cur;
    const total = Math.abs(target - start);
    if(total === 0){ progress = 100; }
    else{
      const gained = Math.abs(cur - start);
      progress = Math.max(0, Math.min(100, Math.round((gained/total)*100)));
    }
    let perDay = null, needs = '—', direction = '';
    if(daysLeft > 0 && dist !== 0){
      perDay = round(Math.abs(dist / daysLeft), 3);
      direction = dist>0 ? '+' : '−';
      needs = `${direction}${perDay}${goal.unit||''}/日`;
    }
    if(daysLeft <= 0 && Math.sign(dist)!==0){
      needs = '期限超過：再設定を推奨';
    }
    return {progress, daysLeft, perDay, needs, direction};
  }

  function round(n, d){ const p = Math.pow(10,d); return Math.round(n*p)/p; }
  function today(){ const d = new Date(); const m = ('0'+(d.getMonth()+1)).slice(-2); const day=('0'+d.getDate()).slice(-2); return `${d.getFullYear()}-${m}-${day}`; }
  function fmt(n){ return (Math.round((n + Number.EPSILON)*1000)/1000).toString(); }
  function badgeColor(p){ if(p>=80) return 'ok'; if(p>=40) return 'warn'; return 'danger'; }
  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

  /** ---------- エクスポート/インポート ---------- */
  exportBtn.addEventListener('click', ()=>{
    const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `life-mvp-backup-${Date.now()}.json`;
    a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
  });
  importFile.addEventListener('change', async (e)=>{
    const file = e.target.files[0]; if(!file) return;
    try{
      const txt = await file.text();
      const data = JSON.parse(txt);
      if(!data.categories) throw new Error('形式が不正です');
      state = data; save(); renderCategories(); renderAll();
      alert('インポートしました');
    }catch(err){
      alert('読み込みに失敗しました：' + err.message);
    }finally{
      e.target.value='';
    }
  });

})();
</script>
</body>
</html>